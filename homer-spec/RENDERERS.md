# Homer Renderers

> Output artifact formats, generation logic, and template specifications.

**Parent**: [README.md](README.md)  
**Related**: [ARCHITECTURE.md](ARCHITECTURE.md) · [ANALYZERS.md](ANALYZERS.md) · [INTEGRATIONS.md](INTEGRATIONS.md)

---

## Renderer Trait

```rust
#[async_trait]
pub trait Renderer: Send + Sync {
    /// Human-readable name for this renderer.
    fn name(&self) -> &'static str;

    /// Output file path relative to repo root.
    fn output_path(&self) -> &'static str;

    /// Generate the artifact content as a string.
    async fn render(
        &self,
        store: &dyn HomerStore,
        config: &HomerConfig,
    ) -> Result<String>;

    /// Write the artifact to disk, handling `<!-- homer:preserve -->` merge.
    /// Default implementation merges preserved blocks if the file already exists.
    async fn write(
        &self,
        store: &dyn HomerStore,
        config: &HomerConfig,
        repo_root: &Path,
    ) -> Result<()>;
}
```

All renderers are stateless — they read from the store and produce a single string artifact. The default `write()` implementation handles `<!-- homer:preserve -->` block merging when the output file already exists. No renderer depends on another renderer's output.

---

## Renderer 1: AGENTS.md / CLAUDE.md

**Output**: Single file at repo root (configurable name)  
**Consumer**: AI coding agents (Claude Code, Cursor, Windsurf, Cline, etc.)  
**Priority**: Tier 1 — this is the primary value delivery

### Structure

````markdown
# {project_name}

> Auto-generated by Homer. Last updated: {timestamp}
> Based on analysis of {commit_count} commits, {pr_count} PRs, {file_count} files.

## Build & Test

```bash
# Build
{build_command}

# Test  
{test_command}

# Lint
{lint_command}
```

## Architecture Overview

{recovered_architecture_description}

### Module Map

| Module | Purpose | Stability | Key Files |
|--------|---------|-----------|-----------|
| {module_name} | {semantic_summary} | {stability_class} | {key_files} |

## Key Documents

Important documentation with summaries:

| Document | Type | Summary |
|----------|------|---------|
| {doc_path} | {doc_type} | {one_line_summary} |

## Load-Bearing Code

These functions/types have the highest structural importance in the codebase.
Modifications require understanding all callers and running the full test suite.

### {function_qualified_name}
- **Salience**: {score} ({classification})
- **Called by**: {caller_count} functions
- **Summary**: {semantic_summary}
- **Invariants**: {invariant_list}
- **Caution**: {caution_notes}

## Change Patterns

When implementing common changes, these files typically change together:

### Adding a new API endpoint
Files: {co_change_set}
Pattern: {description_from_historical_analysis}

### Adding a new database migration
Files: {co_change_set}
Pattern: {description}

## Common Tasks

Based on analysis of {n} historical agent interactions, the most common tasks are:

| Task | Files Typically Involved | Frequency |
|------|------------------------|-----------|
| {task_pattern_name} | {typical_files} | {count} sessions |

## Areas That Confuse Agents

These areas have high correction rates in agent interactions — proceed with extra caution:

| Area | Correction Rate | Common Issue |
|------|----------------|-------------|
| {path} | {rate}% | {typical_correction_description} |

## Danger Zones

Areas requiring extra caution due to high risk scores:

| Area | Risk | Reason |
|------|------|--------|
| {path} | {risk_level} | {reason: high churn + low tests / knowledge silo / etc.} |

## Conventions

- **Naming**: {naming_convention} ({adherence_rate}% adherence)
- **Testing**: {test_framework}, files: {test_file_pattern}
- **Error handling**: {error_approach}
- **Documentation**: {doc_style} style ({coverage_rate}% of public entities documented)
- **Commit messages**: {commit_convention}

## Domain Vocabulary

| Term | Meaning | Code Identifier | Used In |
|------|---------|-----------------|---------|
| {human_term} | {definition} | {code_identifier} | {files_where_used} |

## Key Design Decisions

{adr_list_from_pr_and_document_analysis}
````

### Content Selection Logic

The AGENTS.md renderer must be selective — a 50-page document is worse than a 3-page one for agent context. Selection rules:

1. **Key documents**: Top 10 most-referenced documentation files by cross-reference count
2. **Load-bearing code**: Top 20 by composite salience (configurable)
3. **Change patterns**: Top 10 co-change sets by frequency (configurable)
4. **Common tasks**: Top 10 task patterns by frequency from prompt analysis (if available)
5. **Confusion zones**: Areas where correction rate exceeds threshold (from prompt analysis)
6. **Danger zones**: Only areas where `risk_score > threshold`
7. **Conventions**: Only patterns with > 70% adherence (these are actual conventions, not aspirations)
8. **Domain vocabulary**: Terms that appear in > 5 prompts or > 5 files and aren't standard library terms
9. **Design decisions**: Top 10 most impactful PRs (by files changed × file salience), plus decisions extracted from ADR documents

### Input/Output Circularity

Homer both reads and writes AGENTS.md. See [EXTRACTORS.md](EXTRACTORS.md#inputoutput-circularity) for the handling strategy (diff mode, merge mode, `<!-- homer:preserve -->` markers).

---

## Renderer 2: Module Context

**Output**: One `.context.md` file per directory containing source files  
**Consumer**: AI agents working in a specific area of the codebase  
**Priority**: Tier 1

### Structure

```markdown
# {module_path}

> Auto-generated by Homer for {directory_path}

## Purpose
{semantic_summary_of_module}

## Key Entities
| Name | Kind | Salience | Summary |
|------|------|----------|---------|
| {entity} | {function/type} | {score} | {one_line_summary} |

## Dependencies
- **Imports from**: {list_of_imported_modules}
- **Imported by**: {list_of_importing_modules}
- **External**: {external_deps_used}

## Related Documentation
{list_of_documents_referencing_this_module_with_summaries}

## Change Profile
- **Stability**: {stability_class}
- **Change frequency**: {changes_per_month}
- **Bus factor**: {bus_factor}
- **Documentation coverage**: {pct_of_entities_with_doc_comments}
- **Co-changes with**: {co_change_modules}

## Conventions (if different from project-wide)
{module_specific_patterns}

## Recent Significant Changes
{recent_high_impact_commits_or_prs}
```

### Scoping Logic

Each module context file only includes information about entities *in that directory and its immediate children*. It references parent and sibling modules by path but doesn't repeat their details. This keeps each context file focused and small enough for an agent's context window.

---

## Renderer 3: Skills

**Output**: Claude Code skill files (`.md` in `.claude/skills/` directory)  
**Consumer**: Claude Code  
**Priority**: Tier 2

### Skill Derivation

Skills are derived from two sources, in order of confidence:

1. **Prompt-derived skills** (higher confidence): When 15+ prompts say "add a new API endpoint" and each touches the same 5 files, that's a high-confidence skill derived from *actual developer behavior*.
2. **Commit-inferred skills**: Derived from co-change patterns and commit message analysis when prompt data is unavailable.

### Skill Format

```markdown
---
description: "When adding a new API endpoint to the {service_name} service"
---

# Adding a New API Endpoint

Based on analysis of {n} similar changes in this repository:

## Files to modify (in order)
1. `{route_file}` — Add route definition
2. `{handler_file}` — Implement handler function
3. `{schema_file}` — Define request/response types
4. `{test_file}` — Add endpoint tests
5. `{migration_file}` — Database migration (if needed)

## Patterns to follow
- Handler functions follow the pattern: `async fn handle_{action}_{resource}(...)`
- Response types are defined in `{schema_module}`
- Tests use `{test_framework}` with `{assertion_pattern}`
- Error responses follow the format: `{error_format}`

## Common pitfalls
- {pitfall_from_historical_corrections_or_bug_fixes}
```

---

## Renderer 4: Specification (Topos Format)

**Output**: `.tps` files in `spec/` directory  
**Consumer**: Humans + [Topos](https://github.com/rand/topos) tooling  
**Priority**: Tier 2  
**See**: [INTEGRATIONS.md](INTEGRATIONS.md#topos) for full integration design

### Mapping Homer Analysis → Topos Constructs

| Homer Data | Topos Construct |
|------------|----------------|
| Community clusters | `# Design` sections (architectural areas) |
| High-salience types | `Concept` blocks with fields |
| Stable interface patterns | `Behavior` blocks with ensures/requires |
| Never-violated constraints | `Invariant` blocks |
| Issues/PRs → requirements | `# Requirements` with acceptance criteria |
| Implementation evidence | `## TASK-N` blocks with evidence (PR, commit, coverage) |
| Unknown/uncertain patterns | `[?]` typed holes |
| Soft/approximate patterns | `[~]` soft constraints |
| ADR documents | `# Principles` or `# Design` sections with decision rationale |

### ADR-Derived Content

When the document extractor finds Architecture Decision Records, the spec renderer can incorporate them:

- ADR titles and statuses → `# Principles` entries with status annotations
- ADR context/decision/consequences → design rationale in relevant `# Design` sections
- ADR references to code → evidence linking decisions to implementation

### Example Output

```topos
spec AuthenticationSystem

# Principles

- Security-first: All auth changes require review from security team
- Backward-compatible: Token format changes must be backward-compatible

# Requirements

## REQ-AUTH-1: User Authentication

As a user, I want to authenticate with email and password.

when: user submits valid credentials
the system shall: issue a JWT token with configurable expiration

acceptance:
  given: user with email "test@example.com" exists
  when: valid credentials submitted
  then: JWT token returned with 24h expiration

## REQ-AUTH-2: Token Refresh
[? — Homer detected token refresh behavior but couldn't fully characterize requirements]

# Concepts

Concept User:
  field id (`Uuid`): unique
  field email (`String`): unique, validated
  field password_hash (`String`): bcrypt
  field created_at (`DateTime`)

Concept AuthToken:
  field token (`String`): JWT format
  field user_id (`Uuid`): references User.id
  field expires_at (`DateTime`): default 24h from creation

# Tasks

## TASK-1: Implement User model [REQ-AUTH-1]
file: src/models/user.rs
tests: src/models/user_test.rs
evidence:
  pr: #42
  commit: abc123f
status: done
```

---

## Renderer 5: Report

**Output**: `homer-report.html` (or `.md` fallback)  
**Consumer**: Humans (developers, tech leads, new team members)  
**Priority**: Tier 2

### Sections

1. **Executive Summary**: Project health metrics, key numbers
2. **Architecture Diagram**: Graph visualization of module communities (SVG/Mermaid)
3. **Hotspot Map**: Files colored by composite salience (treemap visualization)
4. **Coupling Analysis**: Cross-community edges, co-change patterns
5. **Trend Charts**: Centrality evolution, coupling ratio over releases
6. **Risk Assessment**: Prioritized list of areas needing attention
7. **Documentation Health**: Coverage metrics, staleness report, undocumented critical code
8. **Agent Effectiveness**: Correction hotspots, common tasks, confusion zones (if prompt data available)
9. **Team Topology**: Contributor patterns, knowledge distribution (Conway's Law inverse)

### Visualization

For HTML output, embed self-contained visualizations (no external dependencies):
- Graph layouts: use a lightweight force-directed layout library or pre-compute with `petgraph` layout algorithms and emit SVG
- Treemaps: d3-based treemap for hotspot visualization
- Charts: inline SVG for trend lines

For Markdown fallback: use Mermaid diagrams and ASCII tables.

---

## Renderer 6: Risk Map

**Output**: `homer-risk.json` (machine-readable)  
**Consumer**: AI agents, CI systems  
**Priority**: Tier 2

### Schema

```json
{
  "version": "1.0",
  "generated_at": "2026-02-07T20:00:00Z",
  "risk_areas": [
    {
      "path": "src/core/engine.rs",
      "risk_level": "high",
      "risk_score": 0.92,
      "reasons": [
        {
          "type": "high_centrality_low_tests",
          "description": "PageRank 0.89 but no test file detected",
          "centrality": 0.89,
          "test_coverage": null
        },
        {
          "type": "knowledge_silo",
          "description": "Only 1 contributor in last 12 months",
          "bus_factor": 1
        },
        {
          "type": "undocumented_critical",
          "description": "High-centrality entity with no doc comment",
          "centrality": 0.89,
          "has_doc_comment": false
        },
        {
          "type": "agent_confusion_zone",
          "description": "28% correction rate in agent interactions",
          "correction_rate": 0.28
        }
      ],
      "recommendations": [
        "Run full test suite after any modification",
        "Request review from contributor X (primary author)",
        "Consider adding test coverage before making changes",
        "Add doc comments to undocumented public entities",
        "Review agent correction history before making changes in this area"
      ]
    }
  ],
  "safe_areas": [
    {
      "path": "src/utils/",
      "risk_level": "low",
      "risk_score": 0.12,
      "stability_class": "reliable_background"
    }
  ]
}
```

### Risk Factor Types

| Type | Source | Description |
|------|--------|-------------|
| `high_centrality_low_tests` | Centrality + structure extractors | High PageRank but no test file detected |
| `knowledge_silo` | Behavioral analyzer | Bus factor of 1 |
| `volatile_critical` | Temporal analyzer | High centrality + high churn |
| `rising_importance` | Temporal analyzer | Centrality increasing rapidly |
| `undocumented_critical` | Document extractor + centrality | High centrality, no doc comment |
| `stale_documentation` | Document extractor + behavioral | Doc comment hasn't changed despite function changes |
| `agent_confusion_zone` | Prompt analyzer | High correction rate in agent interactions |
| `underprompted` | Prompt analyzer + centrality | High-centrality code rarely interacted with via agents (blind spot) |

### Integration

CI systems can consume this to:
- Require additional reviewers for high-risk file changes
- Trigger extended test suites for high-risk areas
- Block merges that modify `stable_core` entities without approval

AI agents can consume this to:
- Calibrate caution level per-file
- Decide whether to run full test suite or targeted tests
- Seek human approval before modifying high-risk code

---

## Rendering Pipeline

All renderers can run in parallel (they only read from the store):

```
homer render --all
    │
    ├── Rayon spawn: AGENTS.md renderer
    ├── Rayon spawn: Module Context renderer (per-directory)
    ├── Rayon spawn: Skills renderer
    ├── Rayon spawn: Spec renderer
    ├── Rayon spawn: Report renderer
    └── Rayon spawn: Risk Map renderer
    
    All complete → report output paths and sizes
```

### Selective Rendering

```bash
# Only render specific formats
homer render --format agents-md
homer render --format agents-md,risk-map
homer render --all --exclude report  # Everything except the HTML report

# Circularity modes for AGENTS.md when a human-curated file exists
homer render --format agents-md --diff     # Show what Homer would add/change
homer render --format agents-md --merge    # Merge with human-curated content
```
